<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Termtrainer ‚Äì Terme zusammenfassen</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; background: linear-gradient(to bottom right,#f0f4ff,#e0f7fa); text-align:center; margin:0; padding:20px; }
  h1 { color:#333; margin:10px 0; font-size:1.8em; }
  #task { font-size:1.6em; margin:15px auto; white-space:pre-line; }
  #result { font-size:1.1em; margin:10px; color:#000; font-weight:400; }
  #score { font-size:1.1em; margin:8px; color:#333; }
  #levelDisplay { font-weight:bold; color:#007bff; margin-bottom:5px; }

  /* Fortschritt */
  #progressContainer { width:80%; max-width:420px; height:20px; background:#ddd; border-radius:10px; margin:10px auto 20px; overflow:hidden; display:flex; }
  .barSegment { height:100%; flex:1; background:#ddd; transition:background .25s; }
  .barSegment.correct { background:#4caf50; }
  .barSegment.wrong   { background:#d9534f; }

  input { padding:10px; font-size:1.2em; width:80%; max-width:420px; text-align:center; border-radius:8px; border:1px solid #aaa; }
  input:focus { outline:none; border-color:#007bff; }
  button { background:#007bff; color:#fff; border:none; padding:10px 18px; margin:6px; font-size:1em; border-radius:8px; cursor:pointer; }
  button:hover { background:#0056b3; }
</style>
</head>
<body>
<h1>Termtrainer ‚Äì Terme zusammenfassen</h1>
<div id="levelDisplay">Level 1: Gleiche Terme</div>
<div id="score">Lade...</div>
<div id="progressContainer"></div>

<div id="task">...</div>

<input type="text" id="answer" placeholder="Zusammengefasster Term" autocomplete="off" spellcheck="false"><br>
<button id="checkBtn">Pr√ºfen</button>
<button id="newBtn">Neue Aufgabe</button>

<p id="result"></p>

<p style="font-size:0.8em;color:#555;margin-top:40px;">
Diese Seite speichert keine pers√∂nlichen Daten und l√§uft vollst√§ndig lokal im Browser.<br>
¬© 2025 Termtrainer ‚Äì Add/Sub Levels
</p>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const answerEl = document.getElementById("answer");
  const checkBtn = document.getElementById("checkBtn");
  const newBtn = document.getElementById("newBtn");
  const taskEl = document.getElementById("task");
  const resultEl = document.getElementById("result");
  const scoreEl = document.getElementById("score");
  const levelDisplay = document.getElementById("levelDisplay");
  const progressContainer = document.getElementById("progressContainer");

  const VARS = ['a','b','m','n','x','y','z'];
  const randomChoice = a => a[Math.floor(Math.random()*a.length)];
  const randomCoeff = (max=9) => Math.floor(Math.random()*max)+1;
  const sgn = () => Math.random()<0.5 ? -1 : +1;

  /* ‚≠ê NEUER fester Tipptext ‚≠ê */
  const FIXED_HINT =
    "Wie fasse ich Terme mit + und ‚Äì zusammen?<br>" +
    "<br><b>1. Beide positiv (+ +)</b><br>" +
    "‚Üí Zahlen addieren, Ergebnis positiv<br>" +
    "üëâ Guthaben + Guthaben = mehr Guthaben<br>" +
    "<br><b>2. Beide negativ (‚Äì ‚Äì)</b><br>" +
    "‚Üí Zahlen addieren, Ergebnis negativ<br>" +
    "üëâ Schulden + Schulden = mehr Schulden<br>" +
    "<br><b>3. Einer positiv, einer negativ (+ ‚Äì oder ‚Äì +)</b><br>" +
    "‚Üí gr√∂√üere Zahl minus kleinere Zahl, Vorzeichen der gr√∂√üeren Zahl<br>" +
    "üëâ Guthaben und Schulden: der gr√∂√üere Betrag gewinnt<br>" +
    "<br><b>Hinweis:</b> richtig sortieren nicht vergessen! (Variablen zuerst, Zahl hinten)";

  let level = 1, correctSolution = "", round = 1, score = 0, totalRounds = 10, firstTry = true;
  const segments = [];

  /* Fortschrittsbalken */
  function initProgressBar() {
    progressContainer.innerHTML = "";
    segments.length = 0;
    for (let i=0;i<totalRounds;i++) {
      const seg = document.createElement("div");
      seg.className = "barSegment";
      progressContainer.appendChild(seg);
      segments.push(seg);
    }
  }
  function updateProgress(correct){
    const idx = round - 1;
    if (idx>=0 && idx<segments.length) {
      const seg = segments[idx];
      if (!seg.classList.contains("correct") && !seg.classList.contains("wrong")) {
        seg.classList.add(correct ? "correct" : "wrong");
      }
    }
  }

  /* Anzeige */
  function showNumberWithOptionalParens(n) {
    if (n < 0) return `(${n})`;
    return Math.random() < 0.75 ? `(+${n})` : `${n}`;
  }

  function formatTerm(coeff, variable="") {
    coeff = Number(coeff);
    if (isNaN(coeff)) coeff = 0;
    if (variable === "") {
      if (coeff < 0) return `(${coeff})`;
      return Math.random() < 0.75 ? `(+${coeff})` : `${coeff}`;
    }
    if (coeff === 1)  return `${variable}`;
    if (coeff === -1) return `-${variable}`;
    return `${coeff}${variable}`;
  }

  /* Canonical form */
  function canonical(str) {
    if (!str) return "0";
    str = str.trim()
             .replace(/^\+/, "")
             .replace(/\s+/g, "")
             .replace(/\*\*/g, "^")
             .replace(/\*/g, "")
             .replace(/\-\-/g, "+")
             .replace(/\+\+/g, "+");

    const parts = str.match(/[+\-]?\d*[a-z]?\^?\d*/g)?.filter(Boolean) || [];

    const parsed = parts.map(p => {
      const m = p.match(/^([+\-]?\d*)([a-z]?)(?:\^(\d+))?$/);
      if (!m) return { coeff: 0, var: "", exp: 0 };

      const variable = m[2] || "";
      const exp = Number(m[3] || (variable ? 1 : 0));
      const raw = m[1];
      let coeff;

      if (raw === "" && variable)      coeff = 1;
      else if (raw === "+")            coeff = 1;
      else if (raw === "-")            coeff = -1;
      else                              coeff = Number(raw);

      if (isNaN(coeff)) coeff = 0;

      return { coeff, var: variable, exp };
    });

    parsed.sort((a,b)=>{
      const aConst = a.var === "", bConst = b.var === "";
      if (aConst && !bConst) return 1;
      if (!aConst && bConst) return -1;
      if (a.var < b.var) return -1;
      if (a.var > b.var) return 1;
      return b.exp - a.exp;
    });

    const combined = [];
    for (const t of parsed) {
      const last = combined[combined.length-1];
      if (last && last.var === t.var && last.exp === t.exp) last.coeff += t.coeff;
      else combined.push({ ...t });
    }

    let result = "";
    for (const t of combined) {
      if (t.coeff === 0) continue;
      let part = "";

      if (t.var === "") {
        part = t.coeff.toString();
        if (t.coeff > 0 && result) part = "+" + part;
      } else if (t.coeff === 1) {
        part = t.var + (t.exp > 1 ? "^" + t.exp : "");
        if (result) part = "+" + part;
      } else if (t.coeff === -1) {
        part = "-" + t.var + (t.exp > 1 ? "^" + t.exp : "");
      } else {
        part = t.coeff + t.var + (t.exp > 1 ? "^" + t.exp : "");
        if (t.coeff > 0 && result) part = "+" + part;
      }
      result += part;
    }
    return result || "0";
  }

  /* Eingabe bereinigen */
  function cleanPreserveOrder(str){
    if (!str) return "";
    return str.trim()
              .replace(/^\+/, "")
              .replace(/\s+/g,"")
              .replace(/\*\*/g,"^")
              .replace(/\*/g,"")
              .replace(/\-\-/g,"+")
              .replace(/\+\+/g,"+")
              .replace(/(^|[+\-])1([a-z])/g,"$1$2");
  }

  /* ---------- Aufgaben ---------- */

  function createLevel1Task(){
    const v = randomChoice(VARS);
    const c1 = Number(randomCoeff()*sgn());
    const c2 = Number(randomCoeff()*sgn());

    const display = `${formatTerm(c1, v)} ${c2>=0?'+':'-'} ${formatTerm(Math.abs(c2), v)}`;
    const sum = c1 + c2;

    let res;
    if (sum === 0) res = "0";
    else if (sum === 1) res = v;
    else if (sum === -1) res = "-" + v;
    else res = sum + v;

    correctSolution = canonical(res);
    return `${display} = ?`;
  }

  function createLevel2Task(){
    const termCount = Math.floor(Math.random()*3)+2;
    const chosen = [randomChoice(VARS)];
    if (Math.random() < 0.5) {
      let second;
      do { second = randomChoice(VARS); } while (second === chosen[0]);
      chosen.push(second);
    }

    const terms = [];
    for (let i=0;i<termCount;i++){
      const isNumber = Math.random() < 0.3;
      const v = isNumber ? "" : randomChoice(chosen);
      const c = Number(randomCoeff()*sgn());
      terms.push({coeff:c, var:v});
    }

    const pretty = terms.map(t => {
      if (t.var === "") return formatTerm(t.coeff, "");
      return formatTerm(t.coeff, t.var);
    }).join(" + ").replace(/\+\s*\-/g,"- ");

    const sums = new Map();
    for (const t of terms) {
      const key = t.var; const cur = sums.get(key) || 0;
      sums.set(key, cur + t.coeff);
    }

    const entries = Array.from(sums.entries());
    entries.sort((a,b)=>{
      const aConst = a[0]==="";
      const bConst = b[0]==="";
      if (aConst && !bConst) return 1;
      if (!aConst && bConst) return -1;
      return a[0].localeCompare(b[0]);
    });

    let res = "";
    for (const [v,sum] of entries) {
      if (sum === 0) continue;
      let part = "";
      if (v === "") {
        part = sum.toString();
        if (sum > 0 && res) part = "+" + part;
      } else if (sum === 1) {
        part = v; if (res) part = "+" + part;
      } else if (sum === -1) {
        part = "-" + v;
      } else {
        part = sum + v;
        if (sum > 0 && res) part = "+" + part;
      }
      res += part;
    }
    correctSolution = canonical(res || "0");
    return `${pretty} = ?`;
  }

  function createLevel3Task(){
    const v = randomChoice(VARS);
    const outer = Math.floor(Math.random()*9)-4;
    const cVar = Number(randomCoeff()*sgn());
    const cNum = Number(randomCoeff()*sgn());
    const op = Math.random()<0.5 ? '+' : '-';

    const outside = showNumberWithOptionalParens(outer);
    const inside  = `(${formatTerm(cVar, v)} ${cNum>=0?'+':'-'} ${Math.abs(cNum)})`;
    const display = `${outside} ${op} ${inside}`;

    const varPart = (op==='+') ? cVar : -cVar;
    const numPart = outer + ((op==='+') ? cNum : -cNum);

    let res = "";
    if (varPart !== 0) res += (varPart===1? v : varPart===-1? ("-"+v) : (varPart+v));
    if (numPart !== 0) res += (res ? (numPart>0? "+" : "") : "") + numPart;

    correctSolution = canonical(res || "0");
    return `${display} = ?`;
  }

  /* ---------- Ablauf ---------- */

  function newTask(){
    resultEl.innerText="";
    answerEl.value="";
    firstTry=true;

    if (round>totalRounds) {
      level++;
      if (level>3) { resultEl.innerText="üèÜ Alle Level geschafft!"; return; }
      round=1; score=0; segments.forEach(s=>s.className="barSegment");
      levelDisplay.innerText = ["Level 1: Gleiche Terme","Level 2: Verschiedene Variablen","Level 3: Klammerausdr√ºcke"][level-1];
    }

    let task="";
    switch(level){
      case 1: task=createLevel1Task(); break;
      case 2: task=createLevel2Task(); break;
      case 3: task=createLevel3Task(); break;
    }
    taskEl.innerText = task;
    scoreEl.innerText = `Aufgabe ${round} von ${totalRounds} ‚Äì Punkte: ${score}`;
  }

  /* ----- Pr√ºfen mit Fix-Hinweis ----- */
  function check(){
    const raw = answerEl.value.trim();
    if (!raw) {
      resultEl.style.color="#555";
      resultEl.innerText="Bitte gib eine L√∂sung ein.";
      return;
    }
    answerEl.blur();

    const user = cleanPreserveOrder(raw);
    const solution = canonical(correctSolution);
    const ok = (user === solution);

    if (firstTry) {
      updateProgress(ok);

      if (ok) {
        resultEl.style.color="green";
        score++;
        resultEl.innerText = "‚úÖ Richtig! (+1 Punkt)";
      } else {
        resultEl.style.color="#000";
        resultEl.innerHTML =
          `‚ùå Falsch! Richtige L√∂sung: <b>${solution}</b><br><br>${FIXED_HINT}`;
      }

      round++;

    } else {
      if (ok) {
        resultEl.style.color="green";
        resultEl.innerText = "‚úÖ Richtig ‚Äì aber kein Punkt mehr";
      } else {
        resultEl.innerHTML =
          `‚ùå Noch falsch. L√∂sung: <b>${solution}</b><br><br>${FIXED_HINT}`;
      }
    }

    firstTry = false;
    scoreEl.innerText =
      `Aufgabe ${Math.min(round,totalRounds)} von ${totalRounds} ‚Äì Punkte: ${score}`;
  }

  checkBtn.addEventListener("click", check);
  newBtn.addEventListener("click", newTask);
  answerEl.addEventListener("keydown", e => { if (e.key==="Enter") check(); });

  initProgressBar();
  newTask();
});
</script>

</body>
</html>
