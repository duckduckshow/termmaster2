<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Termtrainer ‚Äì Terme zusammenfassen</title>
<style>
  body {
    font-family: system-ui, Arial, sans-serif;
    background: linear-gradient(to bottom right,#f0f4ff,#e0f7fa);
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  h1 { color:#333; margin:10px 0; font-size:1.8em; }
  #task { font-size:1.6em; margin:15px auto; white-space:pre-line; }
  #result { font-size:1.1em; margin:10px; color:#000; font-weight:400; }
  #score { font-size:1.1em; margin:8px; color:#333; }
  #levelDisplay { font-weight:bold; color:#007bff; margin-bottom:5px; }

  #progressContainer {
    width:80%; max-width:400px; height:20px;
    background-color:#ddd; border-radius:10px;
    margin:10px auto 20px; overflow:hidden; display:flex;
  }
  .barSegment { height:100%; flex:1; background:#ddd; transition:background 0.3s; }
  .barSegment.correct { background:#4caf50; }
  .barSegment.wrong { background:#d9534f; }

  input {
    padding:10px; font-size:1.2em; width:80%; max-width:300px;
    text-align:center; border-radius:8px; border:1px solid #aaa;
  }
  input:focus { outline:none; border-color:#007bff; }
  button {
    background:#007bff; color:white; border:none;
    padding:10px 18px; margin:6px; font-size:1em;
    border-radius:8px; cursor:pointer;
  }
  button:hover { background:#0056b3; }
</style>
</head>
<body>
<h1>Termtrainer ‚Äì Terme zusammenfassen</h1>
<div id="levelDisplay">Level 1: Gleiche Terme</div>
<div id="score">Lade...</div>
<div id="progressContainer"></div>
<div id="task">...</div>
<input type="text" id="answer" placeholder="Zusammengefasster Term" autocomplete="off" spellcheck="false"><br>
<button id="checkBtn">Pr√ºfen</button>
<button id="newBtn">Neue Aufgabe</button>
<p id="result"></p>

<p style="font-size:0.8em;color:#555;margin-top:40px;">
Diese Seite speichert keine pers√∂nlichen Daten und l√§uft vollst√§ndig lokal im Browser.<br>
¬© 2025 Termtrainer ‚Äì Add/Sub Levels
</p>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const answerEl=document.getElementById("answer");
  const checkBtn=document.getElementById("checkBtn");
  const newBtn=document.getElementById("newBtn");
  const taskEl=document.getElementById("task");
  const resultEl=document.getElementById("result");
  const scoreEl=document.getElementById("score");
  const levelDisplay=document.getElementById("levelDisplay");
  const progressContainer=document.getElementById("progressContainer");

  const VARS=['a','b','m','n','p','q','x','y','z'];
  const randomChoice=a=>a[Math.floor(Math.random()*a.length)];
  const randomCoeff=()=>Math.floor(Math.random()*9)+1;
  const sgn=()=>Math.random()<0.5?-1:1;

  let level=1, correctSolution="", round=1, score=0, totalRounds=10, firstTry=true;
  const progressSegments = [];

  function setupProgress(){
    progressContainer.innerHTML="";
    for(let i=0;i<totalRounds;i++){
      const seg=document.createElement("div");
      seg.className="barSegment";
      progressContainer.appendChild(seg);
      progressSegments.push(seg);
    }
  }

function updateProgress(correct){
  const index = round - 1; // aktuelle Aufgabe (0-basiert)
  if (index >= 0 && index < progressSegments.length) {
    const seg = progressSegments[index];
    if (!seg.classList.contains("correct") && !seg.classList.contains("wrong")) {
      seg.classList.add(correct ? "correct" : "wrong");
    }
  }
}

  function formatTerm(coeff, variable){
    if(variable===""){
      if(coeff>=0 && Math.random()<0.75) return `(+${coeff})`;
      return coeff<0?`(${coeff})`:`${coeff}`;
    }
    if(coeff===1) return variable;
    if(coeff===-1) return `-${variable}`;
    return coeff+variable;
  }

  function normalizeTerm(str){
    if(!str) return "0";
    str=str.trim().replace(/\s+/g,"").replace(/^(\+)/,"");
    const parts=str.match(/[+\-]?\d*[a-z]?(?:\^\d+)?/g)?.filter(Boolean)||[];
    const parsed=parts.map(p=>{
      const m=p.match(/^([+\-]?\d*)([a-z]?)(?:\^(\d+))?$/);
      if(!m) return {coeff:0,var:"",exp:0};
      let coeff=m[1];
      const variable=m[2]||"";
      const exp=Number(m[3]|| (variable?1:0));
      if(coeff===""||coeff==="+") coeff=1;
      else if(coeff==="‚àí"||coeff==="-") coeff=-1;
      coeff=Number(coeff);
      if(isNaN(coeff)) coeff=0;
      return {coeff,var:variable,exp};
    });
    parsed.sort((a,b)=>{
      if(a.var<b.var)return -1;
      if(a.var>b.var)return 1;
      return b.exp-a.exp;
    });
    const combined=[];
    for(const t of parsed){
      if(t.coeff===0)continue;
      const last=combined[combined.length-1];
      if(last&&last.var===t.var&&last.exp===t.exp) last.coeff+=t.coeff;
      else combined.push({...t});
    }
    let result="";
    for(const t of combined){
      if(t.coeff===0)continue;
      let part="";
      if(t.var===""){
        part=t.coeff.toString();
        if(t.coeff>0&&result)part="+"+part;
      }else if(t.coeff===1){
        part=t.var+(t.exp>1?"^"+t.exp:"");
        if(result)part="+"+part;
      }else if(t.coeff===-1){
        part="-"+t.var+(t.exp>1?"^"+t.exp:"");
      }else{
        part=t.coeff+t.var+(t.exp>1?"^"+t.exp:"");
        if(t.coeff>0&&result)part="+"+part;
      }
      result+=part;
    }
    return result||"0";
  }

  function createLevel1Task(){
    const v=randomChoice(VARS);
    const c1=Number(randomCoeff()*sgn());
    const c2=Number(randomCoeff()*sgn());
    const term=`${formatTerm(c1,v)} ${c2>=0?'+':'-'} ${formatTerm(Math.abs(c2),v)}`;
    const sum=c1+c2;
    let formatted="";
    if(sum===0)formatted="0";
    else if(sum===1)formatted=v;
    else if(sum===-1)formatted="-"+v;
    else formatted=sum+v;
    correctSolution=normalizeTerm(formatted);
    return `${term} = ?`;
  }

  function createLevel2Task(){
    const count=Math.floor(Math.random()*3)+2;
    const used=new Set();
    let terms=[];
    for(let i=0;i<count;i++){
      let v=randomChoice(VARS);
      while(used.has(v))v=randomChoice(VARS);
      used.add(v);
      const c=randomCoeff()*sgn();
      terms.push(formatTerm(c,v));
    }
    const expression=terms.join(" + ").replace(/\+\s*\-/g,"- ");
    const parsed=terms.map(t=>{
      const m=t.match(/([+\-]?\d*)([a-z])/);
      if(!m)return {coeff:0,var:""};
      let coeff=m[1];
      if(coeff===""||coeff==="+")coeff=1;
      if(coeff==="-")coeff=-1;
      return {coeff:Number(coeff),var:m[2]};
    });
    parsed.sort((a,b)=>a.var.localeCompare(b.var));
    let result="";
    for(const t of parsed){
      if(t.coeff===0)continue;
      if(result&&t.coeff>0)result+="+";
      if(t.coeff===1)result+=t.var;
      else if(t.coeff===-1)result+="-"+t.var;
      else result+=t.coeff+t.var;
    }
    correctSolution=normalizeTerm(result);
    return `${expression} = ?`;
  }

  function createLevel3Task(){
    const a=randomCoeff()*sgn();
    const b=randomCoeff()*sgn();
    const c=randomCoeff()*sgn();
    const v=randomChoice(VARS);
    const term=`(${formatTerm(a,"")}) - (${formatTerm(b,v)} ${c>=0?'-':'+'} ${formatTerm(Math.abs(c),"")})`;
    const res=a - b - c;
    let result="";
    if(res===0)result="0";
    else if(res===1)result=v;
    else if(res===-1)result="-"+v;
    else result=res+v;
    correctSolution=normalizeTerm(result);
    return `${term} = ?`;
  }

  function newTask(){
    resultEl.innerText="";answerEl.value="";firstTry=true;
    if(round>totalRounds){
      level++;
      if(level>3){resultEl.innerText="üéâ Alle Level geschafft!";return;}
      round=1;score=0;
      progressSegments.forEach(seg=>{seg.className="barSegment";});
      levelDisplay.innerText=`Level ${level}: ${["Gleiche Terme","Verschiedene Variablen","Klammerausdr√ºcke"][level-1]}`;
    }
    let aufgabe="";
    switch(level){
      case 1:aufgabe=createLevel1Task();break;
      case 2:aufgabe=createLevel2Task();break;
      case 3:aufgabe=createLevel3Task();break;
    }
    taskEl.innerText=aufgabe;
    scoreEl.innerText=`Aufgabe ${round} von ${totalRounds} ‚Äì Punkte: ${score}`;
  }

function checkAnswer(){
  const input = answerEl.value.trim();
  if(!input){resultEl.innerText="Bitte gib eine L√∂sung ein.";return;}
  answerEl.blur();
  const correct = normalizeTerm(input) === normalizeTerm(correctSolution);

  updateProgress(correct); // ‚úÖ jetzt direkt hier

  if(correct){
    resultEl.style.color="green";
    if(firstTry){score++;resultEl.innerText="‚úÖ Richtig! (+1 Punkt)";}
    else resultEl.innerText="‚úÖ Richtig (kein Punkt mehr)";
  }else{
    resultEl.style.color="#d00";
    resultEl.innerHTML=`‚ùå Falsch! Richtige L√∂sung: <b>${correctSolution}</b>`;
  }

  firstTry=false;
  round++;
  scoreEl.innerText=`Aufgabe ${Math.min(round,totalRounds)} von ${totalRounds} ‚Äì Punkte: ${score}`;
}


  checkBtn.addEventListener("click",checkAnswer);
  newBtn.addEventListener("click",newTask);
  answerEl.addEventListener("keydown",e=>{if(e.key==="Enter")checkAnswer();});

  setupProgress();
  newTask();

});
</script>
</body>
</html>
